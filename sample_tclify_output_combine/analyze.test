set testdir [file dirname $argv0]
source $testdir/tester.tcl

# kill mutants ['4230', '4262']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-0.1 {
  CREATE TABLE a(b);
  INSERT INTO a VALUES('VVpYn');
  ALTER TABLE a RENAME TO c;
  ALTER TABLE c ADD d;
  UPDATE c SET d = '1547061490';
  CREATE INDEX e ON c(0) WHERE 0;
  ALTER TABLE c ADD f;
  CREATE INDEX g ON c(d);
  ALTER TABLE c RENAME d TO h;
  ANALYZE;
  BEGIN;
  CREATE INDEX i ON c(0);
  ROLLBACK;
  INSERT INTO c(f) VALUES('1405917889');
  SELECT DISTINCT f, h FROM c;
} {1405917889 {} {} 1547061490}

# kill mutants ['1294', '1325', '1326', '3106', '3211']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-1.1 {
  CREATE TEMP TABLE a(b);
  CREATE INDEX c ON a(0);
  ANALYZE c;
} {}

# kill mutants ['4289']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-2.1 {
  CREATE VIRTUAL TABLE rt0 USING rtree_i32(c0, c1, c2);
  CREATE TABLE t1(c0, c1, c2);
  INSERT INTO t1 VALUES('', '', '');
  CREATE VIEW v0 AS SELECT TOTAL(0) OVER() FROM rt0, t1;
  CREATE TRIGGER IF NOT EXISTS BEFORE UPDATE OF c0 ON t1 BEGIN DELETE FROM t1;
  END;
  CREATE INDEX IF NOT EXISTS i26 ON t1(
      0 COLLATE BINARY, CASE WHEN CASE WHEN 0 THEN 0 ELSE 0 END
                            THEN 0 WHEN 0 THEN 0 WHEN 0 COLLATE RTRIM THEN 0 END);
  INSERT OR IGNORE INTO rt0(c1, c0) VALUES(0, x'');
  ANALYZE;
  UPDATE t1 SET c0 = 0;
  ANALYZE;
  INSERT OR REPLACE INTO t1(c2, c0) VALUES(0, 0), (x'', 0);
  SELECT *FROM v0, t1;
} {0.0 0 {} 0 0.0 0 {} {} 0.0 0 {} 0 0.0 0 {} {}}

# kill mutants ['3189', '3212', '3244', '4297', '4329']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-3.1 {
  CREATE TEMP TABLE t0(c0, c1, a, c3, c4);
  CREATE TABLE b(c0);
  INSERT INTO t0(c3, c0, a)
      VALUES('1352363488', 0.44364840931393745, '1753171941');
  INSERT INTO b VALUES(8);
  REPLACE INTO b VALUES('');
  INSERT OR IGNORE INTO t0(c0, c1, c4, c3) VALUES('', 7, 0.6543833307953338, '');
  ANALYZE t0;
  SELECT b.c0 FROM b, t0;
} {8 {} 8 {}}

# kill mutants ['3979']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-4.1 {
  CREATE TABLE t0(a);
  CREATE VIRTUAL TABLE b USING rtree_i32(c, d, e, f, g);
  INSERT INTO b VALUES(1, 0, 'C', '', 0), (x'', '', '	', '', 0);
  INSERT OR REPLACE INTO t0 VALUES(x'');
  INSERT INTO t0 VALUES(0);
  ANALYZE;
  SELECT *FROM t0, b;
} {{} 1 0 0 0 0 0 1 0 0 0 0 {} 0 0 0 0 0 0 0 0 0 0 0}

# kill mutants ['1932', '1933', '1964', '1965', '2015', '2047']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-5.1 {
  CREATE TABLE t1(a);
  CREATE TABLE b(a, c, d);
  INSERT INTO b VALUES(0, 0, ''), ('', x'', 0);
  INSERT OR IGNORE INTO t1 VALUES(''), (x''), (0), (x''), ('');
  CREATE UNIQUE INDEX e ON t1(NULL);
  ANALYZE;
  SELECT t1.a FROM b, t1 WHERE(NULL) ISNULL;
} {{} {} 0 {} {} {} {} 0 {} {}}

# kill mutants ['2960', '2992']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-6.1 {
  CREATE VIRTUAL TABLE rt0 USING rtree(c0, c1, c2, a, c4);
           CREATE VIRTUAL TABLE vt1 USING fts5( '');
           CREATE TABLE t0(c0);
           INSERT OR IGNORE INTO t0 VALUES(x'');
           CREATE VIRTUAL TABLE rt1 USING rtree_i32(c0, c1, c2, c3, c4  );
           ALTER TABLE t0 ADD c75;
           CREATE VIRTUAL TABLE vt0 USING fts5(  UNINDEXED,0 UNINDEXED);
           ANALYZE vt1;
           ANALYZE;
           BEGIN;
           ALTER TABLE t0 RENAME TO c91;
           PRAGMA main.mmap_size = 85317;
} {85317}
do_execsql_test analyze-dredd-6.2 {
           ROLLBACK;
           INSERT OR IGNORE INTO rt0(c0, c4, c2, c1) VALUES(1, x'', x'', ''),     ('', '', x'', 0);
           INSERT OR REPLACE INTO t0(c75) VALUES(x'' );
           SELECT *FROM t0, rt0;
} {{} {} 1 0.0 0.0 0.0 0.0 {} {} 0 0.0 0.0 0.0 0.0 {} {} 1 0.0 0.0 0.0 0.0 {} {} 0 0.0 0.0 0.0 0.0}

# kill mutants ['4049', '4081']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-7.1 {
  CREATE TABLE a(b);
  ALTER TABLE a RENAME TO c;
  ALTER TABLE c ADD d;
  REPLACE INTO c VALUES(0, NULL);
  CREATE INDEX e ON c(0);
  CREATE INDEX f ON c(0);
  ALTER TABLE c RENAME TO a;
  ANALYZE;
  ALTER TABLE a RENAME TO c;
  ANALYZE f;
} {}

# kill mutants ['208', '240']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-8.1 {
  ANALYZE temp;
  ANALYZE temp;
} {}

# kill mutants ['4080']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-9.1 {
  CREATE TABLE a(b);
  ALTER TABLE a RENAME TO c;
  ALTER TABLE c ADD d;
  REPLACE INTO c VALUES(9, 0.39792820950889674), (0, NULL);
  CREATE INDEX e ON c(0) WHERE 0;
  ALTER TABLE c ADD f;
  CREATE INDEX g ON c(d);
  ALTER TABLE c RENAME d TO h;
  ANALYZE;
  SELECT DISTINCT(f), h FROM c;
} {{} {} {} 0.397928209508897}

# kill mutants ['3106', '3156']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-10.1 {
  CREATE TEMP VIEW a AS SELECT 0;
  ANALYZE a;
} {}

# kill mutants ['1598']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-11.1 {
  CREATE TEMP TABLE a(b, c, d, e, f);
  ALTER TABLE a RENAME TO g;
  INSERT INTO g VALUES(0, 0, 0, 0, '1710602170');
  CREATE INDEX h ON g(0, 0, 0, 0, 0, 0);
  ANALYZE temp;
} {}

# kill mutants ['3100']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-12.1 {
  CREATE TEMPORARY TABLE a(b, c);
  INSERT INTO a(c) VALUES(0);
  INSERT INTO a(b) VALUES(0);
  CREATE INDEX d ON a(0) WHERE 0;
  CREATE INDEX e ON a(c);
  ANALYZE temp;
  SELECT DISTINCT *FROM a;
} {0 {} {} 0}

# kill mutants ['1597']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-13.1 {
  CREATE TABLE a(b, c);
  INSERT INTO a VALUES(0, 'e6c7');
  ALTER TABLE a RENAME TO d;
  CREATE INDEX e ON d(0, 0, 0, 0, 0);
  ANALYZE;
} {}

# kill mutants ['1590']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test analyze-dredd-14.1 {
  CREATE VIRTUAL TABLE vt70 USING fts5( 1 );
          ANALYZE;
} {}

finish_test
