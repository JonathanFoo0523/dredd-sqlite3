set testdir [file dirname $argv0]
source $testdir/tester.tcl

# kill mutants ['5248', '5251', '5252', '5257', '5262', '5274']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test alter-dredd-1.1 {
  CREATE TABLE a(b);
  ALTER TABLE a ADD c;
  CREATE VIEW d AS SELECT a.c FROM a;
  ALTER TABLE a RENAME TO e;
} {}

# kill mutants ['1000', '1010', '1011', '1014', '899', '910', '931', '942', '968', '978', '979', '982']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test alter-dredd-2.1 {
  CREATE TABLE a(b);
  ALTER TABLE a RENAME TO d;
  ALTER TABLE d ADD e;
  ALTER TABLE d ADD c;
  INSERT INTO d VALUES('', NULL, 0.25571066417654464),
      (0.7716346881230244, '', '');
  CREATE INDEX f ON d(e DESC);
  SELECT(CAST(e AS)) FROM d;
} {0 {} }

# kill mutants ['5249', '5256', '5258', '5259']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test alter-dredd-3.1 {
  CREATE TABLE a(b);
  ALTER TABLE a RENAME b TO c;
  CREATE VIEW d AS SELECT a.c FROM a;
  ALTER TABLE a RENAME TO e;
} {}

# kill mutants ['4738', '4744', '4748', '4749', '4750', '4754', '4757', '4770', '4776', '4780', '4781', '4782', '4786', '4789', '4818', '4850', '5186', '5211', '5212', '5218', '5243', '5244', '5261', '5264']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_catchsql_test alter-dredd-4.1 {
  CREATE TEMP TABLE a(b);
  ALTER TABLE a ADD c;
  CREATE TEMP VIEW d AS SELECT c FROM a;
  ALTER TABLE a RENAME c TO e;
} {1 {error in view d: no such column: e}}

# kill mutants ['2574', '2576', '2584', '2606', '2608', '2616']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_catchsql_test alter-dredd-5.1 {
  CREATE TABLE a(b CHECK(CASE WHEN 3 THEN(c) WHEN 1 THEN TRUE END), c);
  INSERT INTO a(b) VALUES('');
  ALTER TABLE a RENAME c TO d;
  ALTER TABLE a RENAME b TO e;
  UPDATE a SET(d) = 0;
} {1 {CHECK constraint failed: CASE WHEN 3 THEN(d) WHEN 1 THEN TRUE END}}

# kill mutants ['2438', '2470']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test alter-dredd-6.1 {
  CREATE TABLE a(b);
  CREATE VIEW c AS SELECT DISTINCT b FROM a;
  ALTER TABLE a RENAME b TO d;
} {}

# kill mutants ['68', '69']
reset_db
sqlite3_db_config db DEFENSIVE 1
do_execsql_test alter-dredd-7.1 {
  CREATE TABLE a(b);
  ALTER TABLE a ADD c;
} {}

finish_test
